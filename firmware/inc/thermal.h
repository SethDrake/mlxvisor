#pragma once 
#ifndef __THERMAL_H
#define __THERMAL_H

#include <stm32f4xx_hal.h>
#include <mlx90640.h>

#define THERM_COEFF 0.0625
#define TEMP_COEFF 0.25
#define SUPPLY_VOLTAGE 3.3f
#define RECALC_DELAY 15

class IRSensor {
public:
	IRSensor();
	~IRSensor();
	bool init(I2C_HandleTypeDef* i2c, const uint8_t* colorScheme);
	void setColorScheme(const uint8_t* colorScheme);
	uint16_t* readSerialNumber();
	void readMlxEE();
	void convertMlxEEToParams();
	mlx90640_refreshrate_t readRefreshRate();
	void setRefreshRate(mlx90640_refreshrate_t rate);
	mlx90640_resolution_t readADCResolution();
	void setADCResolution(mlx90640_resolution_t resolution);
	mlx90640_mode_t readMlxMode();
	void setMlxMode(mlx90640_mode_t mode);
	bool isFrameReady();
	bool isImageReady();
	void readImage();
	void calculateTempMap(float emissivity);
	void calculateImageMap();
	void findMinAndMaxTemp();
	uint16_t getSubPage();
	float getVdd();
	float getTa();
	float* getTempMap();
	float getMaxTemp();
	float getMinTemp();
	float getCenterTemp();
	uint16_t getHotDotIndex();
	uint16_t getColdDotIndex();
	uint16_t temperatureToRGB565(float temperature, float minTemp, float maxTemp);
	void visualizeImage(uint16_t* fb, uint16_t sizeX, uint16_t sizeY, uint8_t method);
	void drawGradient(uint16_t* fb, uint16_t sizeX, uint16_t sizeY);
protected:
	uint16_t rgb2color(uint8_t R, uint8_t G, uint8_t B);
	uint8_t calculateRGB(uint8_t rgb1, uint8_t rgb2, float t1, float step, float t);
	uint8_t IsPixelBad(uint16_t index);
	uint8_t CheckAdjacentPixels(uint16_t pix1, uint16_t pix2);
private:
	I2C_HandleTypeDef* i2c;
	volatile bool _isImageReady;
	uint16_t fbSizeX;
	uint16_t fbSizeY;
	const uint8_t* colorScheme;
	paramsMLX90640_t mlxParams;
	uint16_t mlxEE[832];
	uint16_t frameData[834];
	uint16_t recalcCnt;
	float vdd;
	float ta;
	float dots[24*32];
	uint16_t colors[24*32];
	uint16_t coldDotIndex;
	uint16_t hotDotIndex;
	float minTemp;
	float maxTemp;
	float centerTemp;
	const float minTempCorr = -0.5;
	const float maxTempCorr = 0.5;

	uint16_t mlxSerialNumber[3];
};


static const uint8_t DEFAULT_COLOR_SCHEME[] = {
	 28, 1, 108 ,
	 31, 17, 218 ,
	 50, 111, 238 ,
	 63, 196, 229 ,
	 64, 222, 135 ,
	 192, 240, 14 ,
	 223, 172, 18 ,
	 209, 111, 14 ,
	 210, 50, 28 ,
	 194, 26, 0 ,
	 132, 26, 0 
};

static const uint8_t ALTERNATE_COLOR_SCHEME[] = {
	 0, 0, 5 ,
	 7, 1, 97 ,
	 51, 1, 194 ,
	 110, 2, 212 ,
	 158, 6, 150 ,
	 197, 30, 58 ,
	 218, 66, 0 ,
	 237, 137, 0 ,
	 246, 199, 23 ,
	 251, 248, 117 ,
	 252, 254, 253 
};

static const float s_dots[768] = {
	28.6113281f,
	28.4841003f,
	28.4608765f,
	29.4021301f,
	29.550293f,
	28.9498291f,
	28.8970947f,
	30.4723511f,
	29.3292847f,
	29.1315918f,
	29.4350586f,
	29.666626f,
	29.6921387f,
	30.0716553f,
	32.6125793f,
	33.568573f,
	37.7875366f,
	33.4588928f,
	30.8253479f,
	30.2276001f,
	28.4132385f,
	30.9433289f,
	29.0616455f,
	29.2255859f,
	29.2384033f,
	28.4529419f,
	28.6060791f,
	28.7442627f,
	27.3526306f,
	28.6316833f,
	27.0177002f,
	28.1833191f,
	30.3332825f,
	28.8741455f,
	29.8027039f,
	28.259491f,
	29.4775085f,
	28.8420715f,
	29.2096558f,
	29.3107605f,
	28.8564453f,
	28.4139404f,
	30.3161926f,
	29.3514099f,
	30.0144348f,
	30.0065613f,
	32.8757324f,
	32.8372803f,
	37.6963196f,
	32.0622559f,
	31.5155029f,
	29.3756104f,
	29.4026794f,
	28.8799438f,
	30.223053f,
	29.3129883f,
	30.5575867f,
	28.4528503f,
	29.4375916f,
	27.8578186f,
	28.3016357f,
	27.8694763f,
	28.9008484f,
	28.1189575f,
	28.3735352f,
	28.7865906f,
	28.0858765f,
	28.9191284f,
	29.0993958f,
	28.5410156f,
	28.9062500f,
	28.4238892f,
	29.3328247f,
	28.4227600f,
	30.1985168f,
	29.8286743f,
	29.5050659f,
	29.8598938f,
	31.9364319f,
	33.9807739f,
	37.7846069f,
	34.0239563f,
	30.7523193f,
	30.5948486f,
	31.1332092f,
	30.0909729f,
	28.4735718f,
	28.2775879f,
	29.1861877f,
	28.8818054f,
	28.4976501f,
	29.0792236f,
	29.326416f,
	27.9120178f,
	28.9884949f,
	27.3327637f,
	29.3084412f,
	29.1782837f,
	29.1424255f,
	29.4732971f,
	29.4614258f,
	28.4804077f,
	30.4285583f,
	30.5197754f,
	29.8562317f,
	29.1092834f,
	29.1629639f,
	29.3164978f,
	30.5575867f,
	29.3962097f,
	32.7333374f,
	35.3868103f,
	40.3044434f,
	33.3895264f,
	30.671875f,
	30.0644531f,
	29.7774658f,
	29.2990723f,
	30.7584839f,
	27.8031921f,
	29.1401367f,
	28.4045715f,
	28.2662354f,
	29.0014343f,
	29.4570007f,
	27.6119385f,
	28.5426941f,
	28.000061f,
	28.5873718f,
	28.7831421f,
	29.1980896f,
	28.9573059f,
	28.9580994f,
	28.4169006f,
	29.6756592f,
	29.6621704f,
	28.2058411f,
	28.817749f,
	29.7256775f,
	29.3058472f,
	29.8842468f,
	30.0200806f,
	33.5497131f,
	38.4638367f,
	39.7816772f,
	33.3206482f,
	29.6860352f,
	30.3806152f,
	30.0457764f,
	29.7358398f,
	29.8488159f,
	29.3084412f,
	29.0731506f,
	29.6141357f,
	28.2860413f,
	27.7225952f,
	27.6716003f,
	27.9430847f,
	27.4448853f,
	28.1155396f,
	28.3722534f,
	28.1847229f,
	28.8823547f,
	29.0078735f,
	29.4214172f,
	29.8628845f,
	29.175293f,
	28.3687744f,
	29.275116f,
	29.1031494f,
	29.8109741f,
	29.3104553f,
	30.1552429f,
	29.9105225f,
	32.7633972f,
	39.4235229f,
	40.3000793f,
	32.5206909f,
	30.6318054f,
	30.7485046f,
	29.7554016f,
	29.7996216f,
	28.8971252f,
	28.9950562f,
	29.2123718f,
	27.8059387f,
	29.0830994f,
	27.7748413f,
	28.6866455f,
	28.4606323f,
	28.7645874f,
	27.7824402f,
	29.0982056f,
	29.2137756f,
	29.7691956f,
	29.132019f,
	29.8684082f,
	28.2278748f,
	29.4387512f,
	29.2069092f,
	29.321106f,
	29.2411804f,
	29.3631287f,
	30.2747192f,
	29.7864075f,
	30.1241455f,
	33.2185059f,
	39.3269348f,
	37.9588013f,
	32.8087463f,
	30.2883606f,
	31.1749878f,
	29.9451599f,
	29.2732849f,
	29.4184265f,
	29.5856323f,
	28.4721375f,
	28.4346619f,
	27.8936157f,
	29.410614f,
	28.6888123f,
	28.7724304f,
	28.3526001f,
	27.862915f,
	28.7003784f,
	27.9230652f,
	29.6149902f,
	29.5844116f,
	28.6048889f,
	28.4829102f,
	29.7250977f,
	28.6694336f,
	29.3829346f,
	29.0879822f,
	29.9584351f,
	30.1361389f,
	31.1794434f,
	29.3352966f,
	34.2629395f,
	41.1953735f,
	38.9596863f,
	31.8652344f,
	30.5191345f,
	30.3242493f,
	30.5652161f,
	28.8441467f,
	30.1941528f,
	28.6673279f,
	29.0976868f,
	27.7986145f,
	28.6195679f,
	29.0708313f,
	28.7927856f,
	27.4155273f,
	28.5041199f,
	27.9495239f,
	28.7156982f,
	28.8588562f,
	28.6685181f,
	29.4148254f,
	29.3631592f,
	28.1343079f,
	29.2103271f,
	29.505127f,
	29.3916321f,
	29.3255615f,
	29.4622498f,
	29.8540039f,
	30.2221069f,
	30.7060547f,
	35.1867981f,
	42.6663513f,
	35.0932922f,
	31.8386841f,
	29.3367004f,
	30.2049561f,
	29.6617126f,
	29.7747192f,
	29.162323f,
	28.9598083f,
	28.9237061f,
	28.3411255f,
	28.0708618f,
	28.5405273f,
	28.3925781f,
	28.2402039f,
	27.6353149f,
	28.2368469f,
	29.4465027f,
	28.2098694f,
	30.1324768f,
	29.3929138f,
	29.0462341f,
	28.7201538f,
	29.6502686f,
	28.600769f,
	29.440918f,
	29.7377014f,
	29.1451721f,
	28.9945068f,
	30.2573853f,
	29.3759766f,
	34.8334656f,
	42.7572632f,
	34.0715942f,
	31.0737f,
	30.745575f,
	30.0180664f,
	29.4455261f,
	29.1145325f,
	29.7382507f,
	28.7684937f,
	29.1805725f,
	28.6179504f,
	28.4970703f,
	29.2931213f,
	29.0924988f,
	28.5010986f,
	27.9703369f,
	28.1045227f,
	28.384613f,
	28.9500427f,
	28.7172546f,
	29.1183777f,
	28.5078735f,
	29.2636719f,
	29.4458313f,
	29.5429688f,
	29.1129456f,
	28.4476929f,
	29.1132507f,
	29.8933716f,
	29.7730408f,
	29.2503662f,
	36.1378174f,
	42.460968f,
	33.1196594f,
	31.2153625f,
	30.0579834f,
	30.1138916f,
	29.0438232f,
	30.1338196f,
	29.2369995f,
	28.3121643f,
	29.5469055f,
	27.9429932f,
	28.4124756f,
	28.8566589f,
	27.7060242f,
	28.0066833f,
	28.1056213f,
	27.2973328f,
	29.3160706f,
	28.29599f,
	29.9529419f,
	29.0827332f,
	29.6750183f,
	28.5209351f,
	29.1022034f,
	28.9908447f,
	29.6494446f,
	29.1118164f,
	28.9752808f,
	29.203125f,
	30.3136597f,
	29.4477844f,
	35.1980591f,
	42.6531372f,
	33.2847595f,
	30.8748474f,
	30.5777283f,
	29.1272278f,
	29.4478455f,
	29.19104f,
	29.1123352f,
	29.1580505f,
	28.828186f,
	28.4901733f,
	29.6558533f,
	27.9282227f,
	27.3398438f,
	27.4573364f,
	28.422821f,
	27.497406f,
	28.5189514f,
	28.959259f,
	30.9386292f,
	28.9178467f,
	28.7415466f,
	29.5530396f,
	29.0745544f,
	29.5341187f,
	29.020752f,
	28.7029114f,
	29.6614075f,
	29.9093323f,
	29.2841187f,
	30.0993958f,
	36.5012207f,
	43.1864014f,
	30.8112793f,
	30.6208801f,
	30.2518616f,
	29.9480591f,
	29.0210876f,
	29.7979126f,
	27.8130493f,
	30.0603638f,
	28.6212769f,
	28.3248291f,
	28.6987f,
	27.8381958f,
	27.5444946f,
	28.1176453f,
	27.8818359f,
	28.1399231f,
	30.0362549f,
	29.679657f,
	29.4551697f,
	30.4296265f,
	29.8326416f,
	28.7428894f,
	29.741333f,
	29.8045349f,
	29.4033813f,
	29.755188f,
	28.6244812f,
	29.7020264f,
	30.4665527f,
	29.6128845f,
	35.5556946f,
	42.6534424f,
	32.1281433f,
	30.9162598f,
	30.6010437f,
	29.5592957f,
	29.2415161f,
	28.816925f,
	28.54953f,
	29.5131836f,
	29.0849609f,
	28.1507263f,
	29.1341858f,
	28.9920349f,
	27.9738159f,
	28.105957f,
	27.5396423f,
	28.161438f,
	28.4470825f,
	28.7442627f,
	29.1192322f,
	27.8943787f,
	29.4291992f,
	28.4656677f,
	29.005188f,
	29.0046387f,
	28.853363f,
	29.4168091f,
	29.9794006f,
	29.7030945f,
	29.8919678f,
	30.4139404f,
	37.5664062f,
	42.4457703f,
	30.5991821f,
	30.7444153f,
	29.8529663f,
	29.5410461f,
	29.1631775f,
	28.9537659f,
	29.5389404f,
	28.45755f,
	28.2328796f,
	29.0307617f,
	28.0765686f,
	28.426178f,
	28.0343933f,
	28.3346252f,
	27.8436279f,
	28.2832947f,
	30.1822815f,
	28.5983582f,
	28.4720459f,
	28.7379761f,
	29.5307922f,
	29.099823f,
	29.5055542f,
	28.5788879f,
	28.6818237f,
	29.3428955f,
	29.1080627f,
	29.9601135f,
	29.9178772f,
	30.3923035f,
	36.1648254f,
	42.4962158f,
	31.9244995f,
	29.7794495f,
	30.024231f,
	28.8457642f,
	29.5143738f,
	28.3981323f,
	28.7378845f,
	29.5027161f,
	28.6507263f,
	27.02771f,
	28.6881714f,
	28.2242126f,
	28.1246033f,
	27.7325745f,
	28.5510559f,
	27.0145569f,
	29.068573f,
	27.7427368f,
	28.3168335f,
	28.2060852f,
	28.7301331f,
	29.2156372f,
	29.0793152f,
	29.1160278f,
	28.8286133f,
	29.4059753f,
	29.019104f,
	29.18396f,
	29.9002686f,
	31.0017395f,
	37.431427f,
	41.8735657f,
	31.0729675f,
	30.5002441f,
	30.3083496f,
	29.8545227f,
	29.7758484f,
	28.7199097f,
	28.7590332f,
	28.2422485f,
	27.9375305f,
	29.14328f,
	28.8648071f,
	28.7451477f,
	28.1029053f,
	28.6496582f,
	27.8717346f,
	27.5950012f,
	28.53302f,
	27.6039429f,
	28.8730774f,
	28.4151306f,
	29.4313354f,
	28.3910217f,
	29.2131348f,
	29.5186462f,
	29.1311646f,
	28.6013489f,
	29.1948547f,
	28.7041321f,
	30.1644592f,
	30.1259766f,
	36.6474609f,
	40.7279358f,
	30.7224731f,
	29.6229553f,
	30.4682617f,
	29.4239502f,
	29.6168823f,
	28.1397705f,
	28.9003296f,
	27.471344f,
	29.2497864f,
	28.171875f,
	28.7831726f,
	27.7322998f,
	28.9787903f,
	27.8103943f,
	27.8025818f,
	27.2683411f,
	28.7492371f,
	28.044342f,
	28.5682678f,
	28.2963562f,
	28.7538757f,
	29.348877f,
	29.1255188f,
	29.0158997f,
	28.4337158f,
	29.9708557f,
	29.4361267f,
	28.7202759f,
	30.0059814f,
	30.4235229f,
	34.4024658f,
	37.8917542f,
	30.6199951f,
	30.7928162f,
	30.0360413f,
	29.2573547f,
	30.092804f,
	29.2832336f,
	28.7662964f,
	29.1728516f,
	28.8544922f,
	28.4544067f,
	27.6506042f,
	28.6233215f,
	28.3708496f,
	27.499115f,
	28.5767517f,
	27.3417053f,
	28.9349365f,
	28.7107239f,
	29.3182068f,
	28.4778137f,
	28.8713989f,
	27.6969604f,
	29.2884216f,
	29.0300903f,
	28.2407837f,
	28.467804f,
	29.5536194f,
	28.9194641f,
	30.3364563f,
	29.3301697f,
	33.5308533f,
	36.6351013f,
	30.8058777f,
	31.0359192f,
	30.1832581f,
	28.099823f,
	28.4494934f,
	28.4997864f,
	29.4623413f,
	28.5195923f,
	28.2526245f,
	27.997345f,
	27.7049255f,
	27.1864624f,
	28.1853943f,
	27.1861267f,
	27.423584f,
	28.1733398f,
	28.2015686f,
	26.6071472f,
	29.1642151f,
	28.4216309f,
	28.6571045f,
	28.1173401f,
	28.203186f,
	29.0237732f,
	28.774231f,
	28.828949f,
	29.4670105f,
	28.9556274f,
	29.8815308f,
	30.1480408f,
	32.3295593f,
	33.6143188f,
	30.4873047f,
	29.9996338f,
	30.3940735f,
	29.6125183f,
	28.9494324f,
	28.4509888f,
	29.5502625f,
	28.6513977f,
	27.9290466f,
	28.2842712f,
	28.0296631f,
	28.771698f,
	28.0066833f,
	27.0396423f,
	28.9916687f,
	27.9133606f,
	29.3346252f,
	28.6217041f,
	30.353241f,
	28.7821655f,
	27.97229f,
	29.3215332f,
	29.0499573f,
	29.1870728f,
	30.0010681f,
	28.2807312f,
	29.578949f,
	29.4772339f,
	30.3511658f,
	30.2197571f,
	32.6081238f,
	33.4578857f,
	30.6452026f,
	30.3850403f,
	29.2843018f,
	28.2117615f,
	29.1208191f,
	29.3919067f,
	27.9829712f,
	28.9170532f,
	28.5116272f,
	27.3845825f,
	29.3793030f,
	27.0320740f,
	27.6952209f,
	29.0015259f,
	27.8414612f,
	28.0196533f,
	28.2288208f,
	26.9828796f,
	30.0368347f,
	28.1304321f,
	28.317688f,
	28.5876465f,
	28.4015503f,
	28.6898499f,
	28.7071228f,
	28.5158997f,
	29.3437500f,
	29.2843018f,
	30.4344482f,
	30.7000427f,
	32.5144958f,
	32.0118103f,
	30.3815613f,
	29.8306885f,
	30.5857239f,
	29.4140015f,
	29.4707336f,
	28.4169617f,
	28.8973999f,
	28.196991f,
	28.8319397f,
	28.0002136f,
	29.0369568f,
	28.5587769f,
	27.5229797f,
	28.1727905f,
	27.3412476f,
	28.0820007f,
	28.6967468f,
	27.2151489f,
	29.4916077f,
	27.6187439f,
	31.138855f,
	28.2262878f,
	28.7802734f,
	28.2741394f,
	29.0958557f,
	27.8076477f,
	30.3063354f,
	29.4595642f,
	29.5538635f,
	30.0969543f,
	31.6873474f,
	31.5077209f,
	30.7697144f,
	30.0899048f,
	30.6556091f,
	28.94104f,
	28.7940063f,
	28.5297546f,
	29.174469f,
	29.431427f,
	28.188324f,
	27.3224182f,
	27.7148132f,
	27.98172f,
	28.5300903f,
	26.9519958f,
	28.0477905f,
	27.0523987f 
};

#endif /* __THERMAL_H */


